% tufte.cfg - TeX4ht configuration for Tufte-LaTeX to Tufte-CSS HTML conversion
% Based on: https://tex.stackexchange.com/questions/570630/can-a-tufte-latex-file-output-tufte-css-html
% Reference: https://edwardtufte.github.io/tufte-css/

\Preamble{xhtml}
\Configure{AddCss}{tufte.css}

% Helper macro to close current paragraph
\def\endparagraph{\ifvmode\IgnorePar\fi\EndP}

% Configure body to use article wrapper (tufte-css convention)
\Configure{@BODY}{\endparagraph\HCode{<article>}}
\Configure{@/BODY}{\endparagraph\HCode{</article>}}

% Configure sections (Tufte LaTeX makes \section and \subsection behave like starred versions)
\Configure{likesection}
{\endparagraph\HCode{<section>}}{\endparagraph\HCode{</section>}}
{\HCode{<h2>}}{\HCode{</h2>}\par\ShowPar}

\Configure{likesubsection}
{\endparagraph\HCode{<section>}}{\endparagraph\HCode{</section>}}
{\HCode{<h3>}}{\HCode{</h3>}\par\ShowPar}

% Configure table of contents
\renewcommand\tableofcontents{\endparagraph\HCode{<h2>Contents</h2>\Hnewline}\TableOfContents[likesection,likesubsection]}

\makeatletter

% Configure title page
\renewcommand{\maketitle}{%
  \begingroup%
    \endparagraph\HCode{<h1>}\@title\HCode{</h1>}%
    \HCode{<p class="subtitle">}\@author\HCode{</p>}%
    \HCode{<p class="subtitle">}\@date\HCode{</p>}%
  \endgroup
}

% Configure image dimensions
\Configure{Gin-dim}{}
\Css{img {
    max-width: 100\%;
    height: auto;
}}

% Fix soul package compatibility (for \allcaps, \smallcaps)
\@ifpackageloaded{soul}{%
\renewcommand{\allcaps}[1]{\MakeTextUppercase{#1}}%
\renewcommand{\smallcaps}[1]{{\scshape\MakeTextLowercase{#1}}}%
\renewcommand{\textsc}[1]{\textcaps{#1}}%
}{}

% Configure sidenotes with tufte-css checkbox toggle pattern
\long\def\@tufte@sidenote[#1][#2]#3{%
  \stepcounter\@mpfn%
\bgroup%
  \HCode{<label for="sidenote-\thempfn" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sidenote-\thempfn" class="margin-toggle" />}%
  \HCode{<span class="sidenote">}#3\HCode{</span>}%
\egroup%
}

% Configure margin notes (unnumbered)
\renewcommand\marginnote[2][0pt]{%
  \stepcounter\@mpfn%
\bgroup%
  \HCode{<label for="marginnote-\thempfn" class="margin-toggle">\&\#8853;</label><input type="checkbox" id="marginnote-\thempfn" class="margin-toggle" />}%
  \HCode{<span class="marginnote">}#2\HCode{</span>}%
\egroup%
}

% Configure verbatim environments
\ConfigureEnv{verbatim}{\endparagraph\HCode{<pre><code>}\NoFonts}{\EndNoFonts\endparagraph\HCode{</code></pre>}}{}{}

% Configure fullwidth environment
\ConfigureEnv{fullwidth}{\endparagraph\HCode{<div class="fullwidth">}%
\ConfigureList{list}{}{}{}{}%
\par\ShowPar\indent%
}
{\endparagraph\HCode{</div>}}{}{}

% Configure margin floats (marginfigure)
\NewConfigure{marginfloat}{2}

\renewenvironment{@tufte@margin@float}[2][-1.2ex]%
{\FloatBarrier%
\begingroup%
\let\textwidth\marginparwidth%
\def\@captype{#2}%
\par%
\Configure{HtmlPar}{\EndP\csname a:marginfloat\endcsname}{\EndP\csname a:marginfloat\endcsname}{\csname b:marginfloat\endcsname}{\csname b:marginfloat\endcsname}%
}
{\endgroup}

\Configure{marginfloat}{\HCode{<p><span class="marginnote">}%
\Configure{caption}{\HCode{<span class="figure">}}{:\space}{}{\HCode{</span>}}%
}{\HCode{</span></p>}}{}{}

\Css{.marginnote .figure{display:block;}}

% Configure regular floats
\renewenvironment{@tufte@float}[3][htbp]%
{\@float{#2}[#1]}{\end@float}

% Configure captions
\Configure{caption}{\HCode{<span class="marginnote">}}{:\space}{}{\HCode{</span>}}

% Configure fullwidth figures (figure*)
\ConfigureEnv{figure*}{
\Configure{float}{}{\endparagraph\HCode{<figure class="fullwidth">}}{\endparagraph\HCode{</figure>}\csname par\endcsname\ShowPar}
\Configure{caption}{\endparagraph\HCode{<span class="figure">}}{:\space}{}{\HCode{</span>}}
}{}{}{}

% Configure margin tables
\ConfigureEnv{margintable}{\endparagraph\HCode{<div class="margintable">}\Configure{caption}{}{:\space}{}{}}{\endparagraph\HCode{</div>}}{}{}

% Configure math display width to match tufte-css article width
\Css{div.math-display, div.par-math-display {width: 55\%}}

% Custom CSS for Dartmouth green links and additional styling
\Css{
  a { color: \#00693E; }
  a:hover { color: \#004d2e; }
  .marginnote, .sidenote { font-size: 0.9em; }
  h1, h2, h3 { color: \#333; }
  body { font-family: et-book, Palatino, "Palatino Linotype", "Palatino LT STD", "Book Antiqua", Georgia, serif; }
  .todolist { list-style-type: none; padding-left: 0; }
  .todolist li:before { content: "\\2610 "; }
}

\makeatother

\begin{document}
\EndPreamble
